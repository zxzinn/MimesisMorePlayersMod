name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Download and extract MelonLoader
      run: |
        # Download MelonLoader installer
        Invoke-WebRequest -Uri "https://github.com/LavaGang/MelonLoader/releases/download/v0.6.6/MelonLoader.x64.zip" -OutFile "MelonLoader.zip"

        # Extract to temp location
        Expand-Archive -Path "MelonLoader.zip" -DestinationPath "temp-melon" -Force

        # Create installer MelonLoader-Files directory
        New-Item -ItemType Directory -Path "installer-gui/MelonLoader-Files" -Force

        # Copy MelonLoader folder and version.dll
        Copy-Item -Path "temp-melon/MelonLoader" -Destination "installer-gui/MelonLoader-Files/" -Recurse -Force
        Copy-Item -Path "temp-melon/version.dll" -Destination "installer-gui/MelonLoader-Files/" -Force

        # Verify files exist
        if (-not (Test-Path "installer-gui/MelonLoader-Files/MelonLoader")) {
          throw "MelonLoader directory not found after extraction"
        }

        Write-Host "MelonLoader files prepared successfully"
      shell: pwsh

    - name: Build mod DLL
      run: dotnet build MorePlayers.csproj -c Release

    - name: Build installer
      run: |
        cd installer-gui
        dotnet build Installer.csproj -c Release

    - name: Prepare release files
      run: |
        mkdir release
        copy bin\Release\netstandard2.1\MorePlayers.dll release\

        REM Create installer package directory
        mkdir installer-package
        xcopy installer-gui\bin\Release\net48\*.exe installer-package\ /Y
        xcopy installer-gui\bin\Release\net48\MelonLoader-Files installer-package\MelonLoader-Files\ /E /I /Y

        REM Create zip
        powershell Compress-Archive -Path installer-package\* -DestinationPath release\MorePlayers-Installer.zip -Force
      shell: cmd

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      shell: bash

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/MorePlayers.dll
          release/MorePlayers-Installer.zip
        body: |
          ## MIMESIS MorePlayers Enhanced ${{ steps.get_version.outputs.VERSION }}

          ### üì¶ Downloads

          - **MorePlayers-Installer.zip** - One-click installer (Recommended)
          - **MorePlayers.dll** - Manual installation (requires MelonLoader)

          ### ‚ú® Installation

          **Easy Mode:**
          1. Download `MorePlayers-Installer.zip`
          2. Extract and run `MorePlayers-Installer.exe`
          3. Done!

          **Manual Mode:**
          1. Install [MelonLoader](https://github.com/LavaGang/MelonLoader/releases)
          2. Download `MorePlayers.dll`
          3. Place in `<MIMESIS>/Mods/`

          ### üìù Changelog

          See commit history for details.

          ---

          üí° Only the **HOST** needs this mod installed!
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
