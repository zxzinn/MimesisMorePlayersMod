name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Build mod DLL
      run: dotnet build MorePlayers.csproj -c Release

    - name: Build installer
      run: |
        cd installer-gui
        dotnet publish Installer.csproj -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true

    - name: Prepare release files
      run: |
        mkdir release
        copy bin\Release\netstandard2.1\MorePlayers.dll release\
        copy installer-gui\bin\Release\net8.0-windows\win-x64\publish\MorePlayers-Installer.exe release\
      shell: cmd

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      shell: bash

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/MorePlayers.dll
          release/MorePlayers-Installer.exe
        body: |
          ## MIMESIS MorePlayers Enhanced ${{ steps.get_version.outputs.VERSION }}

          ### üì¶ Downloads

          - **MorePlayers-Installer.exe** - One-click installer (Recommended)
          - **MorePlayers.dll** - Manual installation (requires MelonLoader)

          ### ‚ú® Installation

          **Easy Mode:**
          1. Download `MorePlayers-Installer.exe`
          2. Run it
          3. Done!

          **Manual Mode:**
          1. Install [MelonLoader](https://github.com/LavaGang/MelonLoader/releases)
          2. Download `MorePlayers.dll`
          3. Place in `<MIMESIS>/Mods/`

          ### üìù Changelog

          See commit history for details.

          ---

          üí° Only the **HOST** needs this mod installed!
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
